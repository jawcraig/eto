var EDITOR_CONFIG_DEFAULT={baseurl:"",tour:"tour.xml",imagequality:"full",default_title:"",default_url:"",host_url:"http://localhost:8000/upload.php",host_username:"user",host_password:"password",escape_user_input:"yes",skinid:"smart",transition_skinid:"goto-hs",link_skinid:"web-hs2",empty_skinid:"web-hs-kysymys",default_skinid:"goto-hs"},EDITOR_CONFIG=EDITOR_CONFIG_DEFAULT,CUBE_SIZE=500,CUBE_IMAGE_ORDER=[1,3,4,5,0,2],HOTSPOT_RADIUS=4,GRAB_TOLERANCE=10,SPHERE_DISTANCE=200,CAMERA_FOV_MIN=10,CAMERA_FOV_MAX=
120,CAMERA_FOV_INITIAL=70,CAMERA_SCROLL_ZOOM_SPEED=5,CAMERA_TOUCH_ZOOM_SPEED=3,CAMERA_MIN_LATITUDE=-85,CAMERA_MAX_LATITUDE=85,DOUBLETAP_DELAY=300,TOUCH_ZOOM_TOLERANCE=10;PREVIEW_PADDING=10;PREVIEW_VERTICAL_DISTANCE=20;var camera,scene,renderer,worldCube=null,camera_fov=CAMERA_FOV_INITIAL,texture_placeholder,isUserInteracting=!1,onMouseDownMouseX=0,onMouseDownMouseY=0,lon=90,lat=0,lastTapTime=(new Date).valueOf(),touchesDistance=0,is3DViewEnabled=!0;function assert(a,b){a||$.error(b)}
var Pointer=function(){this.pointerLongitude=this.pointerLatitude=0;this.currentDragMover=this.currentHoverHotspot=null};Pointer.prototype.lat=function(){return this.pointerLatitude};Pointer.prototype.lon=function(){return this.pointerLongitude};Pointer.prototype.setHover=function(a){!a&&this.currentHoverHotspot&&this.currentHoverHotspot.grabObject&&scene.remove(this.currentHoverHotspot.grabObject);(this.currentHoverHotspot=a)&&a.grabObject&&scene.add(a.grabObject)};Pointer.prototype.getHover=function(a){return this.currentHoverHotspot};
Pointer.prototype.startDrag=function(a){this.currentDragMover=a};Pointer.prototype.getDrag=function(){return this.currentDragMover};Pointer.prototype.stopDrag=function(){assert(this.getDrag(),"Stopdrag called while not dragging!");this.currentDragMover=null};Pointer.prototype.pointAtAngle=function(a,b){180<b&&(b-=360);-180>b&&(b+=360);180<a&&(a-=360);-180>a&&(a+=360);this.pointerLatitude=a;this.pointerLongitude=b};
Pointer.prototype.pointAtViewportCoordinates=function(a,b){var c=new THREE.Vector3(a/window.innerWidth*2-1,-b/window.innerHeight*2+1,1),c=c.unproject(camera).sub(camera.position).normalize();pan=Math.atan2(c.z,c.x)/(Math.PI/180);tilt=Math.atan2(Math.sqrt(c.x*c.x+c.z*c.z),c.y)/(Math.PI/180);this.pointAtAngle(90-pan,90-tilt)};
var Command=function(a,b,c){this.defaultFunction=function(){assert(!1,"UNIMPLEMENTED FUNCTION CALLED!")};this.executer=a||this.defaultFunction;this.undoer=b||this.defaultFunction;this.update=c||this.defaultFunction};Command.prototype.isUndoable=function(){return this.undoer&&this.undoer!=this.defaultFunction};Command.prototype.execute=function(){var a=this.executer(this);a&&tour.commandExecuted(this);return a};var Predictor=function(a,b){this.normalWeight=a;this.exactWeight=b;this.prefixes={}};
Predictor.prototype.teachPrefix=function(a,b,c){var d=this.normalWeight;c&&(d=this.exactWeight);this.prefixes[a]?this.prefixes[a][b]=this.prefixes[a][b]?this.prefixes[a][b]+d:d:(this.prefixes[a]={},this.prefixes[a][b]=d)};
Predictor.prototype.getCandidates=function(a){var b=null,c=[],d;for(d in this.prefixes)if(0<d.length&&0===a.lastIndexOf(d,0))for(b in this.prefixes[d])c.push([b,this.prefixes[d][b]]);if(!c.length&&this.prefixes[""])for(b in this.prefixes[""])c.push([b,this.prefixes[""][b]]);c.length||(c=[[tour.determineSkinID(url),0]]);c.sort(function(a,b){return b[1]-a[1]});return c};
var Tour=function(a){this.model=a.firstChild;this.start=getStringDOMAttribute(this.model,"start");this.panoramas={};$("#panoramaselector").append($("<option />").val(this.start).text("Start - select panorama"));$("#panoramalist").append($("<option />").val(EDITOR_CONFIG.default_url).text(EDITOR_CONFIG.default_url));this.loadPanoramas();"smart"==EDITOR_CONFIG.skinid&&(this.skinIdPredictor=this.initializePredictor());this.undoStack=[];this.undoEnabled=!1;this.redoStack=[];this.redoEnabled=!1};
Tour.prototype.loadPanoramas=function(){for(var a=0;a<this.model.childNodes.length;++a){var b=this.model.childNodes[a];"panorama"==b.nodeName&&(b=new Panorama(b,this),this.panoramas[b.id]=b)}};
Tour.prototype.initializePredictor=function(){var a=new Predictor(1,1E3),b=null,c;for(c in this.panoramas)for(var d in this.panoramas[c].hotspots){var e=this.panoramas[c].hotspots[d],f=e.url;a.teachPrefix(f,e.skinid,"exact");"{"==f[0]&&"}"==f[f.length-1]&&(b=f.slice(1,f.length-1),this.panoramas[b]&&a.teachPrefix("{",e.skinid));0===f.lastIndexOf("http://",0)&&(a.teachPrefix("http://",e.skinid,"exact"),a.teachPrefix("https://",e.skinid),a.teachPrefix("www.",e.skinid));0===f.lastIndexOf("https://",0)&&
(a.teachPrefix("https://",e.skinid,"exact"),a.teachPrefix("http://",e.skinid),a.teachPrefix("www.",e.skinid));0===f.lastIndexOf("www.",0)&&(a.teachPrefix("www.",e.skinid,"exact"),a.teachPrefix("http://",e.skinid),a.teachPrefix("https://",e.skinid))}return a};
Tour.prototype.determineSkinID=function(a){if(!a||""===a)return EDITOR_CONFIG.empty_skinid;var b=a.slice(1,a.length-1);return tour.panoramas[b]?EDITOR_CONFIG.transition_skinid:0===a.lastIndexOf("http://",0)||0===a.lastIndexOf("https://",0)||0===a.lastIndexOf("www.",0)?EDITOR_CONFIG.link_skinid:EDITOR_CONFIG.default_skinid};Tour.prototype.getSkinId=function(a,b){var c=null;return c="smart"==EDITOR_CONFIG.skinid?this.skinIdPredictor.getCandidates(b)[0][0]:this.determineSkinID(b)};
Tour.prototype.commandExecuted=function(a){a.isUndoable()&&(this.redoStack=[],this.disableRedo(),this.undoStack.push(a),this.enableUndo())};Tour.prototype.enableUndo=function(){this.undoStack.length&&(this.undoEnabled=!0,$("#undobutton").prop("disabled",!1))};Tour.prototype.disableUndo=function(){this.undoEnabled=!1;$("#undobutton").prop("disabled",!0)};Tour.prototype.enableRedo=function(){this.redoStack.length&&(this.redoEnabled=!0,$("#redobutton").prop("disabled",!1))};
Tour.prototype.disableRedo=function(){this.redoEnabled=!1;$("#redobutton").prop("disabled",!0)};Tour.prototype.undo=function(){if(this.undoEnabled&&this.undoStack.length){var a=this.undoStack.pop();a.undoer(a);this.undoStack.length||this.disableUndo();this.redoStack.push(a);this.enableRedo()}};Tour.prototype.redo=function(){if(this.redoEnabled&&this.redoStack.length){var a=this.redoStack.pop();a.executer(a);this.redoStack.length||this.disableRedo();this.undoStack.push(a);this.enableUndo()}};
var Cube=function(a,b){this.screenSize=this.determineScreenSize(a,b);this.imageData=this.loadImageUrls(a,b)};Cube.prototype.determineScreenSize=function(a,b){var c=null;if(b){if(hasDOMAttribute(a,"prev0url"))return"preview";alert("No preview images found, using default size!")}else c=getStringDOMAttribute(a,"screensize");c||(c="full");return c};
Cube.prototype.loadImageUrls=function(a,b){var c="tile";b&&(c="prev");for(var d=CUBE_IMAGE_ORDER.slice(0),e=[],f=0;f<d.length;++f){var g=getStringDOMAttribute(a,c+d[f]+"url");e.push({url:EDITOR_CONFIG.baseurl+g,image:null})}return e};
var Panorama=function(a){this.model=a;this.id=getStringDOMAttribute(this.model,"id");this.title=getStringDOMAttribute(findFirstDOMChild(this.model,"userdata"),"title");$("#panoramaselector").append($("<option />").val(this.id).text("{"+this.id+"} - "+this.title));$("#panoramalist").append($("<option />").val("{"+this.id+"}").text(this.title));this.screenSizes=[];this.createCubes();this.loadViewSettings(this.model);this.hotspotContainer=findFirstDOMChild(this.model,"hotspots");this.hotspots=[];this.loadHotspots();
this.maxHotspotId=this.hotspots.length+1E3};
Panorama.prototype.createCubes=function(){var a=findFirstDOMChild(this.model,"input");this.previewCube=new Cube(a,"preview");this.fullCube=new Cube(a);for(a=0;a<this.model.childNodes.length;++a){var b=this.model.childNodes[a];"altinput"==b.nodeName&&(b=new Cube(b),this.screenSizes.push({size:b.screenSize,cube:b}))}this.screenSizes.sort(function(a,b){return b.size-a.size});this.screenSizes.unshift({size:this.fullCube.screenSize,cube:this.fullCube});this.screenSizes.push({size:0,cube:this.previewCube})};
Panorama.prototype.loadViewSettings=function(a){a=findFirstDOMChild(a,"view");this.pannorth=getStringDOMAttribute(a,"pannorth");a=findFirstDOMChild(a,"start");this.pan={start:getFloatDOMAttribute(a,"pan"),min:0,max:0};this.tilt={start:getFloatDOMAttribute(a,"tilt"),min:CAMERA_MIN_LATITUDE,max:CAMERA_MAX_LATITUDE};this.fov={start:getFloatDOMAttribute(a,"fov"),min:CAMERA_FOV_MIN,max:CAMERA_FOV_MAX};this.camera_fov=this.fov.start};
Panorama.prototype.loadHotspots=function(){for(var a=0;a<this.hotspotContainer.childNodes.length;++a){var b=this.hotspotContainer.childNodes[a];"hotspot"==b.nodeName&&(b=new Hotspot(b,this),this.hotspots.push(b))}};
Panorama.prototype.createHotspot=function(a,b,c,d){var e=panoramaDocument.createElement("hotspot");c=void 0!==c?c:EDITOR_CONFIG.default_title;d=void 0!==d?d:EDITOR_CONFIG.default_url;setStringDOMAttribute(e,"title",c);setStringDOMAttribute(e,"target","");setFloatDOMAttribute(e,"pan",a);setStringDOMAttribute(e,"skinid",tour.getSkinId(c,d));setStringDOMAttribute(e,"url",d);setStringDOMAttribute(e,"id",this.generateHotspotId());setFloatDOMAttribute(e,"tilt",b);return new Hotspot(e,this)};
Panorama.prototype.attachHotspot=function(a){var b=this.hotspotContainer.lastChild;b&&"#text"==b.nodeName&&b.nodeValue?b.appendData("  "):this.hotspotContainer.appendChild(panoramaDocument.createTextNode("  "));this.hotspotContainer.appendChild(a.model);this.hotspotContainer.appendChild(panoramaDocument.createTextNode("\n    "));assert(a.parent==this,"Hotspot being attached to wrong thing!");this.hotspots.push(a)};
Panorama.prototype.detachHotspot=function(a){a.clearVisuals();for(var b=0;b<this.hotspots.length;++b)if(this.hotspots[b]===a){this.hotspots.splice(b,1);break}(b=a.model.previousSibling)&&"#text"==b.nodeName&&b.nodeValue&&(b.nodeValue=b.nodeValue.slice(0,b.nodeValue.length-2));(b=a.model.nextSibling)&&"#text"==b.nodeName&&b.nodeValue&&(b.nextSibling?b.nodeValue="  ":this.hotspotContainer.removeChild(b));this.hotspotContainer.removeChild(a.model)};
Panorama.prototype.getDeleteHotspotCommand=function(a){var b=new Command(function(a){a=a.stored_hotspot;a.parent.detachHotspot(a);a.clearVisuals();return a},function(a){a=a.stored_hotspot;a.parent.attachHotspot(a);a.parent==panorama&&a.createVisuals()});b.stored_hotspot=a;return b};
Panorama.prototype.getMoveHotspotCommand=function(a){var b=new Command(function(a){var b=a.stored_hotspot;null===a.final_pan&&(a.final_pan=b.pan);null===a.final_tilt&&(a.final_tilt=b.tilt);return a.final_pan!=a.initial_pan||a.final_tilt!=a.initial_tilt?(b.placeAtAngle(a.final_pan,a.final_tilt),b.updateModelAngle(),b):null},function(a){var b=a.stored_hotspot;b.placeAtAngle(a.initial_pan,a.initial_tilt);b.updateModelAngle();return b},function(a,b){this.stored_hotspot.placeAtAngle(a,b)});b.stored_hotspot=
a;b.final_pan=null;b.final_tilt=null;b.initial_pan=a.pan;b.initial_tilt=a.tilt;return b};
Panorama.prototype.getEditHotspotCommand=function(a){var b=new Command(function(a){var b=a.stored_hotspot;null===a.final_title&&(a.final_title=b.title);null===a.final_url&&(a.final_url=b.url);null===a.final_skin&&(a.final_skin=b.skinid);return a.final_title!=a.initial_title||a.final_url!=a.initial_url||a.final_skin!=a.initial_skin?(b.setTitle(a.final_title),b.setUrl(a.final_url),b.setSkin(a.final_skin),b.updateModelProperties(),b):null},function(a){var b=a.stored_hotspot;b.setTitle(a.initial_title);
b.setUrl(a.initial_url);b.setSkin(a.initial_skin);b.updateModelProperties();return b},function(b,d,e){a.setTitle(b);a.setUrl(d);a.setSkin(e)});b.stored_hotspot=a;b.final_title=null;b.final_url=null;b.final_skin=null;b.initial_title=a.title;b.initial_url=a.url;b.initial_skin=a.skinid;return b};
Panorama.prototype.getCreateHotspotCommand=function(a,b){var c=new Command(function(a){a=a.stored_hotspot;a.parent.attachHotspot(a);a.parent==panorama&&a.createVisuals();return a},function(a){a=a.stored_hotspot;a.parent.detachHotspot(a);a.clearVisuals()}),d=this.createHotspot(a,b);c.stored_hotspot=d;return c};
Panorama.prototype.getTransitionCommand=function(a){var b=new Command(function(a){switchToPanorama(a.targetid);return!0},function(a){switchToPanorama(a.originid);return!0});b.originid=this.id;b.targetid=a;return b};Panorama.prototype.generateHotspotId=function(){return"Point"+ ++this.maxHotspotId};
Panorama.prototype.getHotspotAtPointer=function(a){a=getPosition(90-a.lon(),90-a.lat(),SPHERE_DISTANCE);for(var b=0;b<this.hotspots.length;++b)if(hotspot=this.hotspots[b],hotspot.grabObject&&a.distanceTo(hotspot.grabObject.position)<GRAB_TOLERANCE)return hotspot;return null};Panorama.prototype.createVisuals=function(){for(var a=0;a<this.hotspots.length;++a)this.hotspots[a].createVisuals()};Panorama.prototype.clearVisuals=function(){for(var a=0;a<this.hotspots.length;++a)this.hotspots[a].clearVisuals()};
var Hotspot=function(a,b){this.parent=b;this.model=a;this.id=getStringDOMAttribute(this.model,"id");this.pan=getFloatDOMAttribute(a,"pan");this.tilt=getFloatDOMAttribute(a,"tilt");this.url=getStringDOMAttribute(this.model,"url");this.skinid=getStringDOMAttribute(this.model,"skinid");this.skinid_overriden=!1;this.title=getStringDOMAttribute(this.model,"title");this.grabObject=this.visualObject=null;var c=this.skinid,d=!1;$("#skinidlist option").each(function(){if(this.value==c)return d=!0,!1});d||
$("#skinidlist").prepend($("<option />").val(c).text(c))};Hotspot.prototype.placeAtAngle=function(a,b){this.pan=a;this.tilt=b;var c=getPosition(90-b,90-a,SPHERE_DISTANCE);this.visualObject.position.copy(c);this.grabObject.position.copy(c)};Hotspot.prototype.setTitle=function(a){this.title=a};Hotspot.prototype.setUrl=function(a){this.url=a};Hotspot.prototype.setSkin=function(a){this.skinid=a};
Hotspot.prototype.updateModelProperties=function(){setStringDOMAttribute(this.model,"title",this.title);setStringDOMAttribute(this.model,"url",this.url);setStringDOMAttribute(this.model,"skinid",this.skinid)};Hotspot.prototype.updateModelAngle=function(){setFloatDOMAttribute(this.model,"pan",this.pan);setFloatDOMAttribute(this.model,"tilt",this.tilt)};
Hotspot.prototype.createVisuals=function(){this.visualObject=new THREE.Mesh(Hotspot.visualgeometry,Hotspot.visualmaterial);scene.add(this.visualObject);this.grabObject=new THREE.Mesh(Hotspot.grabgeometry,Hotspot.grabmaterial);this.placeAtAngle(this.pan,this.tilt)};Hotspot.prototype.clearVisuals=function(){scene.remove(this.visualObject);this.visualObject=null;scene.remove(this.grabObject);this.grabObject=null};Hotspot.visualgeometry=new THREE.SphereGeometry(HOTSPOT_RADIUS,12,12);
Hotspot.visualmaterial=new THREE.MeshBasicMaterial({color:16711680,overdraw:.5});Hotspot.grabgeometry=new THREE.RingGeometry(GRAB_TOLERANCE-2,GRAB_TOLERANCE,24,1);Hotspot.grabmaterial=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide});var pointer=new Pointer,panoramaDocument=null,tour=null,panorama=null;readConfig();
function init(){var a=document.getElementById("container");camera=new THREE.PerspectiveCamera(camera_fov,window.innerWidth/window.innerHeight,1,1100);scene=new THREE.Scene;texture_placeholder=document.createElement("canvas");texture_placeholder.width=128;texture_placeholder.height=128;var b=texture_placeholder.getContext("2d");b.fillStyle="rgb(200, 200, 200)";b.fillRect(0,0,texture_placeholder.width,texture_placeholder.height);tour=new Tour(panoramaDocument);panorama=null;switchToPanorama(tour.start);
renderer=new THREE.CanvasRenderer;renderer.setSize(window.innerWidth,window.innerHeight);a.appendChild(renderer.domElement);$(window).on("resize",onWindowResize);$(a).on("mousedown",onDocumentMouseDown);$(a).on("dblclick",onDocumentDoubleClick);$(a).on("mousemove",onDocumentMouseMove);$(a).on("mouseup",onDocumentMouseUp);$(a).on("touchstart",onDocumentTouchStart);$(a).on("touchmove",onDocumentTouchMove);$(a).on("touchend",onDocumentTouchEnd);$(a).on("touchcancel",onDocumentTouchCancel);$(a).on("wheel",
onDocumentMouseWheel);$("#uploadxml").on("click",sendXML);$("#downloadxml").on("click",downloadXML);$("#hotspoteditor").find("#cancelbutton").on("click",hideEditor);$("#hotspoteditor").find("#advancedbutton").on("click",function(a){$("#skinidoverride").toggleClass("active")});$("#hotspoteditor").find("#defaultskinbutton").on("click",function(a){$("#hotspoteditor").find("#skininput").val("").text("")});$("#hotspoteditor").on("keyup",function(a){if(13==a.which)return $("#okbutton").trigger("click"),
!1});$("#panoramaselector").change(function(a){a=$("#panoramaselector").val();panorama.getTransitionCommand(a).execute()});$("#undobutton").prop("disabled",!0);$("#redobutton").prop("disabled",!0);$("#undobutton").on("click",function(){tour.undo()});$("#redobutton").on("click",function(){tour.redo()});animate()}
function cleanUpPanorama(){assert(panorama,"CLEANING UP NO PANORAMA");is3DViewEnabled||hideEditor();finishDrag();pointer.setHover(null);hidePreview();panorama.clearVisuals();worldCube&&(scene.remove(worldCube),worldCube=null)}function getCube(a,b){if("preview"==EDITOR_CONFIG.imagequality)return a.previewCube;if("full"==EDITOR_CONFIG.imagequality)return a.fullCube;for(var c=a.screenSizes.length-2;0<c;--c)if(a.screenSizes[c].size>=b)return a.screenSizes[c].cube;return a.screenSizes[0].cube}
function switchToPanorama(a){assert(tour.panoramas[a],"SWITCHING TO INVALID PANORAMA");panorama&&(cleanUpPanorama(),panorama=null);panorama=tour.panoramas[a];console.log("Tour moves to "+panorama.title);lon=90-panorama.pan.start;lat=panorama.tilt.start;a=panorama.previewCube;var b=getCube(panorama,screen.height);a=loadMaterials(a,b);a=new THREE.MeshFaceMaterial(a);b=new THREE.BoxGeometry(CUBE_SIZE,CUBE_SIZE,CUBE_SIZE,7,7,7);worldCube=new THREE.Mesh(b,a);worldCube.scale.x=-1;scene.add(worldCube);panorama.createVisuals()}
function getPosition(a,b,c){a=THREE.Math.degToRad(a);b=THREE.Math.degToRad(b);return new THREE.Vector3(c*Math.sin(a)*Math.cos(b),c*Math.cos(a),c*Math.sin(a)*Math.sin(b))}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)}
function loadMaterials(a,b){for(var c=[],d=0;d<a.imageData.length;++d){var e=new THREE.Texture(texture_placeholder);e.minFilter=THREE.NearestFilter;var f=new THREE.MeshBasicMaterial({map:e,color:16776960,overdraw:.5});c.push(f);loadImages(e,a.imageData[d].url,b.imageData[d].url)}return c}function loadImages(a,b,c){var d=new Image;d.onload=function(){a.image=this;a.needsUpdate=!0;b!=c&&(d=new Image,d.onload=function(){a.image=this;a.needsUpdate=!0},d.src=c)};d.src=b}
function onDocumentMouseDown(a){if(is3DViewEnabled){a.preventDefault();if(1===a.button){var b=pointer.getHover();if(b){var b=b.url.slice(1,b.url.length-1),c=tour.panoramas[b];c?panorama.getTransitionCommand(c.id).execute():console.log("Can't transition to: "+b)}}0===a.button&&(!pointer.getDrag()&&pointer.getHover()?pointer.startDrag(panorama.getMoveHotspotCommand(pointer.getHover())):(isUserInteracting=!0,onPointerDownPointerX=a.clientX,onPointerDownPointerY=a.clientY,onPointerDownLon=lon,onPointerDownLat=
lat))}}function onDocumentDoubleClick(a){is3DViewEnabled&&(a.preventDefault(),0===a.button&&(pointer.getHover()||(hotspot=panorama.getCreateHotspotCommand(pointer.lat(),pointer.lon()).execute(),pointer.setHover(hotspot)),showEditor(pointer.getHover())))}function escapeUserData(a){return"yes"==EDITOR_CONFIG.escape_user_input?escapeHtml(a):a}function escapeHtml(a){return String(a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
function showEditor(a){is3DViewEnabled=!1;hidePreview();pointer.getDrag()&&finishDrag();var b=$("#hotspoteditor");assert(!b.hasClass("active"),"Editor already open!");b.find("#skinidoverride").toggleClass("active",!1);b.find("#okbutton").off("click");b.find("#titleinput").val(a.title);b.find("#urlinput").val(a.url);a.skinid_overriden?b.find("#skininput").val(a.skinid):b.find("#skininput").val("");b.find("#okbutton").one("click",function(c){c=b.find("#titleinput").val();c=$.trim(escapeUserData(c));
var d=b.find("#urlinput").val(),d=$.trim(escapeUserData(d)),e=b.find("#skininput").val(),e=$.trim(escapeUserData(e));""===e?(e=tour.getSkinId(c,d),a.skinid_overriden=!1):a.skinid_overriden=!0;var f=!1;$("#panoramalist option").each(function(){if(this.value==d)return f=!0,!1});f||$("#panoramalist").prepend($("<option />").val(d).text(d));var g=panorama.getEditHotspotCommand(a);g.update(c,d,e);g.execute();hideEditor()});b.find("#deletebutton").one("click",function(b){pointer.getDrag()&&finishDrag();
pointer.setHover(null);panorama.getDeleteHotspotCommand(a).execute();hideEditor()});b.toggleClass("active",!0)}function hideEditor(){var a=$("#hotspoteditor");a.find("#okbutton").off();a.find("#deletebutton").off();a.toggleClass("active",!1);is3DViewEnabled=!0}
function showPreview(a,b,c){var d=$("#hotspotpreview");d.find("#title").html(escapeHtml(a.title));d.find("#url").html(escapeHtml(a.url));void 0!==b&&(a=d.width()+PREVIEW_PADDING,b+a>window.innerWidth&&(b=window.innerWidth-a),d.css("left",b+"px"));void 0!==c&&(b=d.height()+PREVIEW_PADDING,c+b+PREVIEW_VERTICAL_DISTANCE>window.innerHeight&&(c=window.innerHeight-b-PREVIEW_VERTICAL_DISTANCE),d.css("top",c+PREVIEW_VERTICAL_DISTANCE+"px"));d.toggleClass("active",!0)}
function hidePreview(){$("#hotspotpreview").toggleClass("active",!1)}
function onDocumentMouseMove(a){is3DViewEnabled&&(pointer.pointAtViewportCoordinates(a.clientX,a.clientY),pointer.getDrag()||(pointer.setHover(panorama.getHotspotAtPointer(pointer)),pointer.getHover()?showPreview(pointer.getHover(),a.clientX,a.clientY):hidePreview()),pointer.getDrag()?(pointer.getDrag().update(pointer.lat(),pointer.lon()),showPreview(pointer.getHover(),a.clientX,a.clientY)):!0===isUserInteracting&&(lon=.1*(onPointerDownPointerX-a.clientX)+onPointerDownLon,lat=.1*(a.clientY-onPointerDownPointerY)+
onPointerDownLat))}function finishDrag(){var a=pointer.getDrag();a&&(a.execute(),pointer.stopDrag())}function onDocumentMouseUp(a){is3DViewEnabled&&(finishDrag(),isUserInteracting=!1)}function zoomCamera(a,b){camera_fov=clamp(camera_fov+b*(0>a?-1:0<a?1:0),panorama.fov.min,panorama.fov.max)}function onDocumentMouseWheel(a){zoomCamera(a.originalEvent.deltaY,CAMERA_SCROLL_ZOOM_SPEED)}
function onDocumentTouchStart(a){if(is3DViewEnabled){var b=a.touches||a.originalEvent.touches;if(1==b.length){a.preventDefault();hidePreview();pointer.pointAtViewportCoordinates(b[0].clientX,b[0].clientY);onPointerDownPointerX=b[0].pageX;onPointerDownPointerY=b[0].pageY;onPointerDownLon=lon;onPointerDownLat=lat;a=(new Date).valueOf();var c=a-lastTapTime;lastTapTime=a;c<DOUBLETAP_DELAY?(pointer.setHover(panorama.getHotspotAtPointer(pointer)),pointer.getHover()||(hotspot=panorama.getCreateHotspotCommand(pointer.lat(),
pointer.lon()).execute(),pointer.setHover(hotspot)),showEditor(pointer.getHover())):(pointer.getDrag()||(pointer.setHover(panorama.getHotspotAtPointer(pointer)),pointer.getHover()&&(pointer.startDrag(panorama.getMoveHotspotCommand(pointer.getHover())),showPreview(pointer.getHover(),b[0].clientX,b[0].clientY))),pointer.getDrag()||(isUserInteracting=!0))}else 2==b.length&&(touchesDistance=THREE.Vector2(b[0].clientX-b[1].clientX,b[1].clientY-b[1].clientY).length())}}
function onDocumentTouchMove(a){if(is3DViewEnabled){var b=a.touches||a.originalEvent.touches;1==b.length?(a.preventDefault(),(new Date).valueOf()-lastTapTime<DOUBLETAP_DELAY||(pointer.pointAtViewportCoordinates(b[0].clientX,b[0].clientY),pointer.getDrag()?pointer.getDrag().update(pointer.lat(),pointer.lon()):isUserInteracting&&(lon=.1*(onPointerDownPointerX-b[0].pageX)+onPointerDownLon,lat=.1*(b[0].pageY-onPointerDownPointerY)+onPointerDownLat,hidePreview()))):2==b.length&&(a=(new THREE.Vector2(b[0].clientX-
b[1].clientX,b[1].clientY-b[1].clientY)).length(),Math.abs(touchesDistance-a)>TOUCH_ZOOM_TOLERANCE&&(zoomCamera(touchesDistance-a,CAMERA_TOUCH_ZOOM_SPEED),touchesDistance=a))}}function clamp(a,b,c){return Math.max(b,Math.min(c,a))}function onDocumentTouchEnd(a){is3DViewEnabled&&(0===(a.touches||a.originalEvent.touches).length&&finishDrag(),isUserInteracting=!1)}function onDocumentTouchCancel(a){is3DViewEnabled&&(0===(a.touches||a.originalEvent.touches).length&&finishDrag(),isUserInteracting=!1)}
function animate(){requestAnimationFrame(animate);pointer.getHover()&&(pointer.getHover().grabObject.rotation.y+=.1,pointer.getHover().grabObject.rotation.x+=.11);update()}function update(){lat=clamp(lat,panorama.tilt.min,panorama.tilt.max);var a=getPosition(90-lat,lon,500);camera.lookAt(a);camera.fov=camera_fov;camera.updateProjectionMatrix();renderer.render(scene,camera)}
function readConfig(){$.ajax({dataType:"json",url:"panorama_editor_config.json",success:function(a){for(var b in a)EDITOR_CONFIG[b]=a[b]},error:function(a,b,c){alert("Received "+b+" while reading configuration file: "+c)},complete:function(){console.log(EDITOR_CONFIG);readXMLDocument(EDITOR_CONFIG.baseurl+EDITOR_CONFIG.tour)}})}
function readXMLDocument(a){console.log("Loading "+a);var b=null;$.ajax({dataType:"xml",url:a,success:function(a){console.log("Data received.");b=a},error:function(b,d,e){alert("Unable to load XML location: '"+a+"'\n"+d+" : "+e)},complete:function(){b||(a=prompt("Enter tour url",a),readXMLDocument(a));panoramaDocument=b;init()}})}
function generatePanoramaDocument(){return(new DOMParser).parseFromString("<?xml version=\"1.0\"?><tour start='node1'><panorama id='node1'><userdata title='START'></userdata><hotspots></hotspots></panorama></tour>\n","application/xml")}
function sendXML(){$.ajax({url:EDITOR_CONFIG.host_url,username:EDITOR_CONFIG.host_username,password:EDITOR_CONFIG.host_password,type:"POST",contentType:"application/xml",processData:!1,data:panoramaDocument,success:function(a){alert("Data sent to: "+EDITOR_CONFIG.host_url)},error:function(a,b,c){alert("Unable to send data: "+b+" : "+c);EDITOR_CONFIG.host_url=prompt("Give upload url (including 'username:password@'):",EDITOR_CONFIG.host_url);EDITOR_CONFIG.host_username=null;EDITOR_CONFIG.host_password=
null;sendXML()}})}function downloadXML(){data=(new XMLSerializer).serializeToString(panoramaDocument);setDataOutputReference(window.location,data)}function setDataOutputReference(a,b){a.href="data:text/plain;charset=UTF-8;base64,"+encodeURIComponent(btoa(b))}function findFirstDOMChild(a,b){for(var c=0;c<a.childNodes.length;++c)if(a.childNodes[c].nodeName==b)return a.childNodes[c];return null}function setStringDOMAttribute(a,b,c){a.setAttribute(b,c)}
function setFloatDOMAttribute(a,b,c){a.setAttribute(b,c)}function getStringDOMAttribute(a,b){return $.trim(a.getAttribute(b))}function getFloatDOMAttribute(a,b){return parseFloat($.trim(a.getAttribute(b)))}function hasDOMAttribute(a,b){return a.hasAttribute(b)};
